{% extends "base.html" %}
{% block content %}
<div class="lecture">
  <h1>–û–∫–æ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –≤ PostgreSQL</h1>

  <p>
    –û–∫–æ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (window functions) –ø–æ–∑–≤–æ–ª—è—é—Ç –≤—ã—á–∏—Å–ª—è—Ç—å –∑–Ω–∞—á–µ–Ω–∏—è ‚Äú–ø–æ –≥—Ä—É–ø–ø–µ —Å—Ç—Ä–æ–∫‚Äù,
    <strong>–Ω–µ —Å—Ö–ª–æ–ø—ã–≤–∞—è</strong> —Ä–µ–∑—É–ª—å—Ç–∞—Ç, –∫–∞–∫ —ç—Ç–æ –¥–µ–ª–∞–µ—Ç <code>GROUP BY</code>.
    –¢–æ –µ—Å—Ç—å –∫–∞–∂–¥–∞—è —Å—Ç—Ä–æ–∫–∞ –æ—Å—Ç–∞—ë—Ç—Å—è –Ω–∞ –º–µ—Å—Ç–µ, –∞ —Ç—ã –ø–æ–ª—É—á–∞–µ—à—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤—ã—á–∏—Å–ª–µ–Ω–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏:
    —Ä–∞–Ω–≥–∏, –Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω—ã–µ —Å—É–º–º—ã, –∑–Ω–∞—á–µ–Ω–∏—è ‚Äú–ø—Ä–µ–¥—ã–¥—É—â–µ–π —Å—Ç—Ä–æ–∫–∏‚Äù, –¥–æ–ª–∏ –∏ —Ç.–¥.
  </p>

  <div class="callout callout--note">
    <div class="callout__title">–ì–ª–∞–≤–Ω–æ–µ –æ—Ç–ª–∏—á–∏–µ –æ—Ç GROUP BY</div>
    <p class="muted">
      <code>GROUP BY</code> –¥–µ–ª–∞–µ—Ç –ø–æ –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–µ –Ω–∞ –≥—Ä—É–ø–ø—É.<br>
      –û–∫–Ω–∞ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç –≤—Å–µ —Å—Ç—Ä–æ–∫–∏, –Ω–æ —Å—á–∏—Ç–∞—é—Ç ‚Äú–≤–Ω—É—Ç—Ä–∏ –æ–∫–Ω–∞‚Äù –¥–ª—è –∫–∞–∂–¥–æ–π —Å—Ç—Ä–æ–∫–∏.
    </p>
  </div>

  <hr>

  <h2>–°–∏–Ω—Ç–∞–∫—Å–∏—Å OVER</h2>
  <p>
    –ü–æ—á—Ç–∏ –ª—é–±–∞—è –æ–∫–æ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –≤—ã–≥–ª—è–¥–∏—Ç —Ç–∞–∫:
  </p>

  <pre class="sql"><code>func(...) OVER (
  PARTITION BY ...
  ORDER BY ...
  ROWS/RANGE BETWEEN ...
)</code></pre>

  <ul>
    <li><code>PARTITION BY</code> ‚Äî ‚Äú—Ä–∞–∑–¥–µ–ª–∏—Ç—å‚Äù —Å—Ç—Ä–æ–∫–∏ –Ω–∞ –≥—Ä—É–ø–ø—ã (–∫–∞–∫ –º–∏–Ω–∏-<code>GROUP BY</code>, –Ω–æ –±–µ–∑ —Å—Ö–ª–æ–ø—ã–≤–∞–Ω–∏—è)</li>
    <li><code>ORDER BY</code> ‚Äî –ø–æ—Ä—è–¥–æ–∫ —Å—Ç—Ä–æ–∫ –≤–Ω—É—Ç—Ä–∏ –∫–∞–∂–¥–æ–π –≥—Ä—É–ø–ø—ã</li>
    <li><code>ROWS/RANGE ...</code> ‚Äî —Ä–∞–º–∫–∞ –æ–∫–Ω–∞ (frame): –∫–∞–∫–∏–µ —Å—Ç—Ä–æ–∫–∏ —É—á–∞—Å—Ç–≤—É—é—Ç –≤ –≤—ã—á–∏—Å–ª–µ–Ω–∏–∏ –¥–ª—è —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–æ–∫–∏</li>
  </ul>

  <div class="callout callout--tip">
    <div class="callout__title">üí° –ó–∞–ø–æ–º–∏–Ω–∞–ª–∫–∞</div>
    <p>
      <code>PARTITION BY</code> ‚Äî ‚Äú–ø–æ –∫–∞–∫–∏–º –≥—Ä—É–ø–ø–∞–º —Å—á–∏—Ç–∞–µ–º‚Äù, <code>ORDER BY</code> ‚Äî ‚Äú–≤ –∫–∞–∫–æ–º –ø–æ—Ä—è–¥–∫–µ –≤–Ω—É—Ç—Ä–∏ –≥—Ä—É–ø–ø—ã‚Äù,
      —Ä–∞–º–∫–∞ ‚Äî ‚Äú–∫–∞–∫–∏–µ —Å—Ç—Ä–æ–∫–∏ –±–µ—Ä—ë–º‚Äù.
    </p>
  </div>

  <hr>

  <h2>–ü—Ä–∏–º–µ—Ä 1 ‚Äî SUM(...) OVER(PARTITION BY ...) (–∏—Ç–æ–≥ –ø–æ –≥—Ä—É–ø–ø–µ –±–µ–∑ GROUP BY)</h2>
  <p>
    –ü–æ—Å—á–∏—Ç–∞–µ–º —Å—É–º–º—É –∑–∞—Ä–ø–ª–∞—Ç –ø–æ –æ—Ç–¥–µ–ª—É, –Ω–æ –æ—Å—Ç–∞–≤–∏–º —Å—Ç—Ä–æ–∫–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤.
  </p>

  <p class="muted">–î–∞–Ω–Ω—ã–µ:</p>
  <div class="result">
    <div class="result__title">employees</div>
    <div class="table-wrap">
      <table>
        <thead>
          <tr><th>id</th><th>name</th><th>department</th><th>salary</th></tr>
        </thead>
        <tbody>
          <tr><td>1</td><td>Alice</td><td>Sales</td><td>1200</td></tr>
          <tr><td>2</td><td>Bob</td><td>Sales</td><td>900</td></tr>
          <tr><td>3</td><td>Carol</td><td>IT</td><td>1400</td></tr>
          <tr><td>4</td><td>Dave</td><td>IT</td><td>1300</td></tr>
          <tr><td>5</td><td>Eve</td><td>HR</td><td>900</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <p class="muted">–ó–∞–ø—Ä–æ—Å:</p>
  <pre class="sql"><code>SELECT
  id,
  name,
  department,
  salary,
  SUM(salary) OVER (PARTITION BY department) AS dept_total_salary
FROM employees
ORDER BY department, salary DESC;</code></pre>

  <div class="result">
    <div class="result__title">–†–µ–∑—É–ª—å—Ç–∞—Ç:</div>
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>id</th><th>name</th><th>department</th><th>salary</th><th>dept_total_salary</th>
          </tr>
        </thead>
        <tbody>
          <tr><td>5</td><td>Eve</td><td>HR</td><td>900</td><td>900</td></tr>
          <tr><td>3</td><td>Carol</td><td>IT</td><td>1400</td><td>2700</td></tr>
          <tr><td>4</td><td>Dave</td><td>IT</td><td>1300</td><td>2700</td></tr>
          <tr><td>1</td><td>Alice</td><td>Sales</td><td>1200</td><td>2100</td></tr>
          <tr><td>2</td><td>Bob</td><td>Sales</td><td>900</td><td>2100</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="callout callout--note">
    <div class="callout__title">–ß–µ–º —ç—Ç–æ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç GROUP BY?</div>
    <p class="muted">
      –° <code>GROUP BY department</code> —Ç—ã –ø–æ–ª—É—á–∏–ª –±—ã 3 —Å—Ç—Ä–æ–∫–∏ (–ø–æ –æ—Ç–¥–µ–ª–∞–º).
      –ó–¥–µ—Å—å —Ç—ã –ø–æ–ª—É—á–∏–ª 5 —Å—Ç—Ä–æ–∫ (–ø–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º), –Ω–æ —Å –¥–æ–ø. –∫–æ–ª–æ–Ω–∫–æ–π ‚Äú—Å—É–º–º–∞ –ø–æ –æ—Ç–¥–µ–ª—É‚Äù.
    </p>
  </div>

  <hr>

  <h2>–ü—Ä–∏–º–µ—Ä 2 ‚Äî ROW_NUMBER, RANK, DENSE_RANK</h2>
  <p>
    –≠—Ç–∏ —Ñ—É–Ω–∫—Ü–∏–∏ –ø–æ–º–æ–≥–∞—é—Ç –Ω—É–º–µ—Ä–æ–≤–∞—Ç—å —Å—Ç—Ä–æ–∫–∏ –∏ —Å—Ç—Ä–æ–∏—Ç—å —Ä–µ–π—Ç–∏–Ω–≥–∏.
  </p>

  <ul>
    <li><code>ROW_NUMBER()</code> ‚Äî —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä —Å—Ç—Ä–æ–∫–∏ –≤–Ω—É—Ç—Ä–∏ –≥—Ä—É–ø–ø—ã (1,2,3...)</li>
    <li><code>RANK()</code> ‚Äî —Ä–µ–π—Ç–∏–Ω–≥ —Å ‚Äú–¥—ã—Ä–∫–∞–º–∏‚Äù –ø—Ä–∏ —Ä–∞–≤–µ–Ω—Å—Ç–≤–µ (1,1,3...)</li>
    <li><code>DENSE_RANK()</code> ‚Äî —Ä–µ–π—Ç–∏–Ω–≥ –±–µ–∑ ‚Äú–¥—ã—Ä–æ–∫‚Äù (1,1,2...)</li>
  </ul>

  <p class="muted">–î–∞–Ω–Ω—ã–µ:</p>
  <div class="result">
    <div class="result__title">employees</div>
    <div class="table-wrap">
      <table>
        <thead>
          <tr><th>id</th><th>name</th><th>department</th><th>salary</th></tr>
        </thead>
        <tbody>
          <tr><td>1</td><td>Alice</td><td>Sales</td><td>1200</td></tr>
          <tr><td>2</td><td>Bob</td><td>Sales</td><td>1200</td></tr>
          <tr><td>3</td><td>Carol</td><td>Sales</td><td>900</td></tr>
          <tr><td>4</td><td>Dave</td><td>IT</td><td>1400</td></tr>
          <tr><td>5</td><td>Eve</td><td>IT</td><td>1300</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <p class="muted">–ó–∞–ø—Ä–æ—Å:</p>
  <pre class="sql"><code>SELECT
  department,
  name,
  salary,
  ROW_NUMBER() OVER (PARTITION BY department ORDER BY salary DESC, id) AS row_number,
  RANK()       OVER (PARTITION BY department ORDER BY salary DESC) AS rank,
  DENSE_RANK() OVER (PARTITION BY department ORDER BY salary DESC) AS dense_rank
FROM employees
ORDER BY department, salary DESC, name;</code></pre>

  <div class="result">
    <div class="result__title">–†–µ–∑—É–ª—å—Ç–∞—Ç:</div>
    <div class="table-wrap">
      <table>
        <thead>
          <tr><th>department</th><th>name</th><th>salary</th><th>row_number</th><th>rank</th><th>dense_rank</th></tr>
        </thead>
        <tbody>
          <tr><td>IT</td><td>Dave</td><td>1400</td><td>1</td><td>1</td><td>1</td></tr>
          <tr><td>IT</td><td>Eve</td><td>1300</td><td>2</td><td>2</td><td>2</td></tr>
          <tr><td>Sales</td><td>Alice</td><td>1200</td><td>1</td><td>1</td><td>1</td></tr>
          <tr><td>Sales</td><td>Bob</td><td>1200</td><td>2</td><td>1</td><td>1</td></tr>
          <tr><td>Sales</td><td>Carol</td><td>900</td><td>3</td><td>3</td><td>2</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="callout callout--tip">
    <div class="callout__title">üí° –¢–æ–ø-N –ø–æ –≥—Ä—É–ø–ø–µ</div>
    <p class="muted">
      –ß–∞—Å—Ç–∞—è –∑–∞–¥–∞—á–∞: ‚Äú–≤–∑—è—Ç—å —Ç–æ–ø-2 —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –ø–æ –∑–∞—Ä–ø–ª–∞—Ç–µ –≤ –∫–∞–∂–¥–æ–º –æ—Ç–¥–µ–ª–µ‚Äù.
      –û–±—ã—á–Ω–æ —ç—Ç–æ –¥–µ–ª–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ –ø–æ–¥–∑–∞–ø—Ä–æ—Å/CTE —Å <code>ROW_NUMBER()</code> –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é –ø–æ –Ω–µ–º—É.
    </p>
  </div>

  <hr>

  <h2>–ü—Ä–∏–º–µ—Ä 3 ‚Äî —Ç–æ–ø-2 –≤ –∫–∞–∂–¥–æ–π –≥—Ä—É–ø–ø–µ (ROW_NUMBER + –ø–æ–¥–∑–∞–ø—Ä–æ—Å)</h2>

  <p class="muted">–î–∞–Ω–Ω—ã–µ:</p>
  <div class="result">
    <div class="result__title">employees</div>
    <div class="table-wrap">
      <table>
        <thead>
          <tr><th>id</th><th>name</th><th>department</th><th>salary</th></tr>
        </thead>
        <tbody>
          <tr><td>1</td><td>Alice</td><td>Sales</td><td>1200</td></tr>
          <tr><td>2</td><td>Bob</td><td>Sales</td><td>1100</td></tr>
          <tr><td>3</td><td>Carol</td><td>Sales</td><td>900</td></tr>
          <tr><td>4</td><td>Dave</td><td>IT</td><td>1400</td></tr>
          <tr><td>5</td><td>Eve</td><td>IT</td><td>1300</td></tr>
          <tr><td>6</td><td>Mallory</td><td>IT</td><td>800</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <p class="muted">–ó–∞–ø—Ä–æ—Å:</p>
  <pre class="sql"><code>SELECT department, name, salary
FROM (
  SELECT
    department,
    name,
    salary,
    ROW_NUMBER() OVER (PARTITION BY department ORDER BY salary DESC, id) AS rn
  FROM employees
) t
WHERE rn &lt;= 2
ORDER BY department, salary DESC;</code></pre>

  <div class="result">
    <div class="result__title">–†–µ–∑—É–ª—å—Ç–∞—Ç (—Ç–æ–ø-2 –ø–æ –∑–∞—Ä–ø–ª–∞—Ç–µ –≤ –∫–∞–∂–¥–æ–º –æ—Ç–¥–µ–ª–µ):</div>
    <div class="table-wrap">
      <table>
        <thead><tr><th>department</th><th>name</th><th>salary</th></tr></thead>
        <tbody>
          <tr><td>IT</td><td>Dave</td><td>1400</td></tr>
          <tr><td>IT</td><td>Eve</td><td>1300</td></tr>
          <tr><td>Sales</td><td>Alice</td><td>1200</td></tr>
          <tr><td>Sales</td><td>Bob</td><td>1100</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <hr>

  <h2>–ü—Ä–∏–º–µ—Ä 4 ‚Äî LAG –∏ LEAD (–ø—Ä–µ–¥—ã–¥—É—â–µ–µ/—Å–ª–µ–¥—É—é—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ)</h2>
  <p>
    <code>LAG</code> –∏ <code>LEAD</code> –ø–æ–∑–≤–æ–ª—è—é—Ç ‚Äú–∑–∞–≥–ª—è–Ω—É—Ç—å‚Äù –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â—É—é/—Å–ª–µ–¥—É—é—â—É—é —Å—Ç—Ä–æ–∫—É –≤–Ω—É—Ç—Ä–∏ –æ–∫–Ω–∞.
    –≠—Ç–æ —É–¥–æ–±–Ω–æ –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π (–¥–µ–ª—å—Ç), —Ç—Ä–µ–Ω–¥–æ–≤, —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Å –ø—Ä–µ–¥—ã–¥—É—â–µ–π –ø–æ–∫—É–ø–∫–æ–π –∏ —Ç.–¥.
  </p>

  <p class="muted">–î–∞–Ω–Ω—ã–µ:</p>
  <div class="result">
    <div class="result__title">sales</div>
    <div class="table-wrap">
      <table>
        <thead><tr><th>day</th><th>amount</th></tr></thead>
        <tbody>
          <tr><td>2026-01-01</td><td>100</td></tr>
          <tr><td>2026-01-02</td><td>130</td></tr>
          <tr><td>2026-01-03</td><td>90</td></tr>
          <tr><td>2026-01-04</td><td>160</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <p class="muted">–ó–∞–ø—Ä–æ—Å:</p>
  <pre class="sql"><code>SELECT
  day,
  amount,
  LAG(amount)  OVER (ORDER BY day) AS prev_amount,
  amount - LAG(amount) OVER (ORDER BY day) AS delta_from_prev,
  LEAD(amount) OVER (ORDER BY day) AS next_amount
FROM sales
ORDER BY day;</code></pre>

  <div class="result">
    <div class="result__title">–†–µ–∑—É–ª—å—Ç–∞—Ç:</div>
    <div class="table-wrap">
      <table>
        <thead><tr><th>day</th><th>amount</th><th>prev_amount</th><th>delta_from_prev</th><th>next_amount</th></tr></thead>
        <tbody>
          <tr><td>2026-01-01</td><td>100</td><td>NULL</td><td>NULL</td><td>130</td></tr>
          <tr><td>2026-01-02</td><td>130</td><td>100</td><td>30</td><td>90</td></tr>
          <tr><td>2026-01-03</td><td>90</td><td>130</td><td>-40</td><td>160</td></tr>
          <tr><td>2026-01-04</td><td>160</td><td>90</td><td>70</td><td>NULL</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="callout callout--tip">
    <div class="callout__title">üí° –ü–∞—Ä–∞–º–µ—Ç—Ä default</div>
    <p class="muted">
      –£ <code>LAG</code>/<code>LEAD</code> –µ—Å—Ç—å —Ç—Ä–µ—Ç–∏–π –ø–∞—Ä–∞–º–µ—Ç—Ä ‚Äî –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é:
      <code>LEAD(amount, 1, 0)</code> –≤–µ—Ä–Ω—ë—Ç 0, –µ—Å–ª–∏ —Å–ª–µ–¥—É—é—â–µ–π —Å—Ç—Ä–æ–∫–∏ –Ω–µ—Ç.
    </p>
  </div>

  <hr>

  <h2>–ü—Ä–∏–º–µ—Ä 5 ‚Äî —Å–∫–æ–ª—å–∑—è—â–∞—è —Å—É–º–º–∞ (running total)</h2>
  <p>
    –°–∫–æ–ª—å–∑—è—â–∞—è —Å—É–º–º–∞ ‚Äî —ç—Ç–æ —Å—É–º–º–∞ ‚Äú—Å –Ω–∞—á–∞–ª–∞ –¥–æ —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–æ–∫–∏‚Äù.
  </p>

  <div class="callout callout--note">
    <div class="callout__title">–ù—é–∞–Ω—Å PostgreSQL: RANGE vs ROWS</div>
    <p class="muted">
      –ï—Å–ª–∏ —É –æ–∫–Ω–∞ –µ—Å—Ç—å <code>ORDER BY</code>, —Ç–æ –≤ PostgreSQL —Ä–∞–º–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –æ–±—ã—á–Ω–æ:
      <code>RANGE BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW</code>.
      –ü—Ä–∏ –ø–æ–≤—Ç–æ—Ä—è—é—â–∏—Ö—Å—è –∑–Ω–∞—á–µ–Ω–∏—è—Ö —ç—Ç–æ –º–æ–∂–µ—Ç —Å—á–∏—Ç–∞—Ç—å ‚Äú—Å–∫–∞—á–∫–∞–º–∏‚Äù.
      –î–ª—è —É—á–µ–±–Ω—ã—Ö –∑–∞–¥–∞—á –∏ –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ—Å—Ç–∏ —á–∞—â–µ —è–≤–Ω–æ –ø–∏—à—É—Ç <code>ROWS</code>.
    </p>
  </div>

  <p class="muted">–î–∞–Ω–Ω—ã–µ:</p>
  <div class="result">
    <div class="result__title">sales</div>
    <div class="table-wrap">
      <table>
        <thead><tr><th>day</th><th>amount</th></tr></thead>
        <tbody>
          <tr><td>2026-01-01</td><td>100</td></tr>
          <tr><td>2026-01-02</td><td>130</td></tr>
          <tr><td>2026-01-03</td><td>90</td></tr>
          <tr><td>2026-01-04</td><td>160</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <p class="muted">–ó–∞–ø—Ä–æ—Å:</p>
  <pre class="sql"><code>SELECT
  day,
  amount,
  SUM(amount) OVER (
    ORDER BY day
    ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW
  ) AS running_sum
FROM sales
ORDER BY day;</code></pre>

  <div class="result">
    <div class="result__title">–†–µ–∑—É–ª—å—Ç–∞—Ç:</div>
    <div class="table-wrap">
      <table>
        <thead><tr><th>day</th><th>amount</th><th>running_sum</th></tr></thead>
        <tbody>
          <tr><td>2026-01-01</td><td>100</td><td>100</td></tr>
          <tr><td>2026-01-02</td><td>130</td><td>230</td></tr>
          <tr><td>2026-01-03</td><td>90</td><td>320</td></tr>
          <tr><td>2026-01-04</td><td>160</td><td>480</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <hr>

  <h2>–ü—Ä–∏–º–µ—Ä 6 ‚Äî —Å–∫–æ–ª—å–∑—è—â–µ–µ —Å—Ä–µ–¥–Ω–µ–µ (moving average) –∑–∞ 3 —Å—Ç—Ä–æ–∫–∏</h2>
  <p>
    –û–∫–æ–Ω–Ω–∞—è —Ä–∞–º–∫–∞ –ø–æ–∑–≤–æ–ª—è–µ—Ç –±—Ä–∞—Ç—å ‚Äú–æ–∫—Ä–µ—Å—Ç–Ω–æ—Å—Ç—å‚Äù —Å—Ç—Ä–æ–∫–∏: –Ω–∞–ø—Ä–∏–º–µ—Ä —Ç–µ–∫—É—â–∞—è –∏ –¥–≤–µ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö.
  </p>

  <p class="muted">–î–∞–Ω–Ω—ã–µ:</p>
  <div class="result">
    <div class="result__title">sales</div>
    <div class="table-wrap">
      <table>
        <thead><tr><th>day</th><th>amount</th></tr></thead>
        <tbody>
          <tr><td>2026-01-01</td><td>100</td></tr>
          <tr><td>2026-01-02</td><td>130</td></tr>
          <tr><td>2026-01-03</td><td>90</td></tr>
          <tr><td>2026-01-04</td><td>160</td></tr>
          <tr><td>2026-01-05</td><td>110</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <p class="muted">–ó–∞–ø—Ä–æ—Å:</p>
  <pre class="sql"><code>SELECT
  day,
  amount,
  ROUND(
    AVG(amount) OVER (
      ORDER BY day
      ROWS BETWEEN 2 PRECEDING AND CURRENT ROW
    ),
    2
  ) AS moving_avg_3
FROM sales
ORDER BY day;</code></pre>

  <div class="result">
    <div class="result__title">–†–µ–∑—É–ª—å—Ç–∞—Ç:</div>
    <div class="table-wrap">
      <table>
        <thead><tr><th>day</th><th>amount</th><th>moving_avg_3</th></tr></thead>
        <tbody>
          <tr><td>2026-01-01</td><td>100</td><td>100.00</td></tr>
          <tr><td>2026-01-02</td><td>130</td><td>115.00</td></tr>
          <tr><td>2026-01-03</td><td>90</td><td>106.67</td></tr>
          <tr><td>2026-01-04</td><td>160</td><td>126.67</td></tr>
          <tr><td>2026-01-05</td><td>110</td><td>120.00</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <hr>

  <h2>–ü—Ä–∏–º–µ—Ä 7 ‚Äî —Å—Ä–µ–¥–Ω–µ–µ –ø–æ –≥—Ä—É–ø–ø–µ + —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –Ω–∏–º</h2>
  <p>
    –°—Ä–∞–≤–Ω–∏–º –∑–∞—Ä–ø–ª–∞—Ç—É —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ —Å–æ —Å—Ä–µ–¥–Ω–µ–π –ø–æ –æ—Ç–¥–µ–ª—É.
  </p>

  <p class="muted">–î–∞–Ω–Ω—ã–µ:</p>
  <div class="result">
    <div class="result__title">employees</div>
    <div class="table-wrap">
      <table>
        <thead><tr><th>name</th><th>department</th><th>salary</th></tr></thead>
        <tbody>
          <tr><td>Alice</td><td>Sales</td><td>1200</td></tr>
          <tr><td>Bob</td><td>Sales</td><td>900</td></tr>
          <tr><td>Carol</td><td>Sales</td><td>1100</td></tr>
          <tr><td>Dave</td><td>IT</td><td>1400</td></tr>
          <tr><td>Eve</td><td>IT</td><td>1300</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <p class="muted">–ó–∞–ø—Ä–æ—Å:</p>
  <pre class="sql"><code>SELECT
  department,
  name,
  salary,
  ROUND(AVG(salary) OVER (PARTITION BY department), 2) AS dept_avg_salary,
  ROUND(salary - AVG(salary) OVER (PARTITION BY department), 2) AS diff_from_avg
FROM employees
ORDER BY department, salary DESC;</code></pre>

  <div class="result">
    <div class="result__title">–†–µ–∑—É–ª—å—Ç–∞—Ç:</div>
    <div class="table-wrap">
      <table>
        <thead><tr><th>department</th><th>name</th><th>salary</th><th>dept_avg_salary</th><th>diff_from_avg</th></tr></thead>
        <tbody>
          <tr><td>IT</td><td>Dave</td><td>1400</td><td>1350.00</td><td>50.00</td></tr>
          <tr><td>IT</td><td>Eve</td><td>1300</td><td>1350.00</td><td>-50.00</td></tr>
          <tr><td>Sales</td><td>Alice</td><td>1200</td><td>1066.67</td><td>133.33</td></tr>
          <tr><td>Sales</td><td>Carol</td><td>1100</td><td>1066.67</td><td>33.33</td></tr>
          <tr><td>Sales</td><td>Bob</td><td>900</td><td>1066.67</td><td>-166.67</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <hr>

  <h2>–ü—Ä–∏–º–µ—Ä 8 ‚Äî FIRST_VALUE –∏ LAST_VALUE (–Ω—é–∞–Ω—Å —Ä–∞–º–∫–∏!)</h2>
  <p>
    <code>FIRST_VALUE</code> –∏ <code>LAST_VALUE</code> –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç –ø–µ—Ä–≤–æ–µ/–ø–æ—Å–ª–µ–¥–Ω–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –≤ –æ–∫–Ω–µ.
    –í PostgreSQL –µ—Å—Ç—å —Ç–æ–Ω–∫–æ—Å—Ç—å: <code>LAST_VALUE</code> –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ä–∞–º–∫–∏ –æ–∫–Ω–∞.
  </p>

  <p class="muted">–î–∞–Ω–Ω—ã–µ:</p>
  <div class="result">
    <div class="result__title">prices</div>
    <div class="table-wrap">
      <table>
        <thead><tr><th>day</th><th>price</th></tr></thead>
        <tbody>
          <tr><td>2026-01-01</td><td>10</td></tr>
          <tr><td>2026-01-02</td><td>12</td></tr>
          <tr><td>2026-01-03</td><td>11</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <p class="muted">–ó–∞–ø—Ä–æ—Å:</p>
  <pre class="sql"><code>SELECT
  day,
  price,
  FIRST_VALUE(price) OVER (ORDER BY day) AS first_price,
  -- –ë–µ–∑ —è–≤–Ω–æ–π —Ä–∞–º–∫–∏ last_value —á–∞—Å—Ç–æ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è "—Ç–µ–∫—É—â–∏–º" –∑–Ω–∞—á–µ–Ω–∏–µ–º
  LAST_VALUE(price) OVER (ORDER BY day) AS last_value_default_frame,
  -- –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π "–ø–æ—Å–ª–µ–¥–Ω–∏–π –≤ –ø–æ–ª–Ω–æ–º –æ–∫–Ω–µ":
  LAST_VALUE(price) OVER (
    ORDER BY day
    ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
  ) AS last_price_full_window
FROM prices
ORDER BY day;</code></pre>

  <div class="result">
    <div class="result__title">–†–µ–∑—É–ª—å—Ç–∞—Ç:</div>
    <div class="table-wrap">
      <table>
        <thead>
          <tr><th>day</th><th>price</th><th>first_price</th><th>last_value_default_frame</th><th>last_price_full_window</th></tr>
        </thead>
        <tbody>
          <tr><td>2026-01-01</td><td>10</td><td>10</td><td>10</td><td>11</td></tr>
          <tr><td>2026-01-02</td><td>12</td><td>10</td><td>12</td><td>11</td></tr>
          <tr><td>2026-01-03</td><td>11</td><td>10</td><td>11</td><td>11</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="callout callout--tip">
    <div class="callout__title">üí° –í—ã–≤–æ–¥</div>
    <p class="muted">
      –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—à—å <code>LAST_VALUE</code> –∏ —Ö–æ—á–µ—à—å ‚Äú–ø–æ—Å–ª–µ–¥–Ω–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –≤—Å–µ–π –≥—Ä—É–ø–ø—ã‚Äù ‚Äî
      –ø–æ—á—Ç–∏ –≤—Å–µ–≥–¥–∞ —è–≤–Ω–æ –∑–∞–¥–∞–≤–∞–π —Ä–∞–º–∫—É –¥–æ <code>UNBOUNDED FOLLOWING</code>.
    </p>
  </div>

  <hr>

  <h2>–ü—Ä–∏–º–µ—Ä 9 ‚Äî –¥–æ–ª—è –≤ —Å—É–º–º–µ (–ø—Ä–æ—Ü–µ–Ω—Ç –æ—Ç –∏—Ç–æ–≥–∞)</h2>
  <p>
    ‚Äú–ö–∞–∫—É—é –¥–æ–ª—é –æ—Ç —Å—É–º–º—ã –ø–æ –æ—Ç–¥–µ–ª—É —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç –∑–∞—Ä–ø–ª–∞—Ç–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞?‚Äù
  </p>

  <p class="muted">–î–∞–Ω–Ω—ã–µ:</p>
  <div class="result">
    <div class="result__title">employees</div>
    <div class="table-wrap">
      <table>
        <thead><tr><th>name</th><th>department</th><th>salary</th></tr></thead>
        <tbody>
          <tr><td>Alice</td><td>Sales</td><td>1200</td></tr>
          <tr><td>Bob</td><td>Sales</td><td>900</td></tr>
          <tr><td>Carol</td><td>IT</td><td>1400</td></tr>
          <tr><td>Dave</td><td>IT</td><td>1300</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <p class="muted">–ó–∞–ø—Ä–æ—Å:</p>
  <pre class="sql"><code>SELECT
  department,
  name,
  salary,
  SUM(salary) OVER (PARTITION BY department) AS dept_total,
  ROUND(
    salary::numeric / SUM(salary) OVER (PARTITION BY department) * 100,
    2
  ) AS pct_of_dept
FROM employees
ORDER BY department, salary DESC;</code></pre>

  <div class="result">
    <div class="result__title">–†–µ–∑—É–ª—å—Ç–∞—Ç:</div>
    <div class="table-wrap">
      <table>
        <thead><tr><th>department</th><th>name</th><th>salary</th><th>dept_total</th><th>pct_of_dept</th></tr></thead>
        <tbody>
          <tr><td>IT</td><td>Carol</td><td>1400</td><td>2700</td><td>51.85</td></tr>
          <tr><td>IT</td><td>Dave</td><td>1300</td><td>2700</td><td>48.15</td></tr>
          <tr><td>Sales</td><td>Alice</td><td>1200</td><td>2100</td><td>57.14</td></tr>
          <tr><td>Sales</td><td>Bob</td><td>900</td><td>2100</td><td>42.86</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="callout callout--note">
    <div class="callout__title">–ó–∞—á–µ–º salary::numeric?</div>
    <p class="muted">
      –í PostgreSQL —Ü–µ–ª–æ—á–∏—Å–ª–µ–Ω–Ω–æ–µ –¥–µ–ª–µ–Ω–∏–µ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –ø–æ—Ç–µ—Ä–µ –¥—Ä–æ–±–Ω–æ–π —á–∞—Å—Ç–∏.
      –ö–∞—Å—Ç –∫ <code>numeric</code> –¥–∞—ë—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é –º–∞—Ç–µ–º–∞—Ç–∏–∫—É.
    </p>
  </div>

  <hr>

  <h2>–ò–º–µ–Ω–æ–≤–∞–Ω–Ω—ã–µ –æ–∫–Ω–∞ (WINDOW) ‚Äî –º–µ–Ω—å—à–µ –∫–æ–ø–∏–ø–∞—Å—Ç—ã</h2>
  <p>
    –í PostgreSQL –º–æ–∂–Ω–æ –æ–±—ä—è–≤–∏—Ç—å –æ–∫–Ω–æ –æ–¥–∏–Ω —Ä–∞–∑ —á–µ—Ä–µ–∑ <code>WINDOW</code> –∏ –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –µ–≥–æ.
  </p>

  <p class="muted">–î–∞–Ω–Ω—ã–µ:</p>
  <div class="result">
    <div class="result__title">employees</div>
    <div class="table-wrap">
      <table>
        <thead><tr><th>id</th><th>name</th><th>department</th><th>salary</th></tr></thead>
        <tbody>
          <tr><td>1</td><td>Alice</td><td>Sales</td><td>1200</td></tr>
          <tr><td>2</td><td>Bob</td><td>Sales</td><td>900</td></tr>
          <tr><td>3</td><td>Carol</td><td>IT</td><td>1400</td></tr>
          <tr><td>4</td><td>Dave</td><td>IT</td><td>1300</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <p class="muted">–ó–∞–ø—Ä–æ—Å:</p>
  <pre class="sql"><code>SELECT
  department,
  name,
  salary,
  SUM(salary) OVER w AS dept_total,
  ROW_NUMBER() OVER w_ordered AS rn_in_dept
FROM employees
WINDOW
  w AS (PARTITION BY department),
  w_ordered AS (PARTITION BY department ORDER BY salary DESC, id)
ORDER BY department, salary DESC;</code></pre>

  <div class="result">
    <div class="result__title">–†–µ–∑—É–ª—å—Ç–∞—Ç:</div>
    <div class="table-wrap">
      <table>
        <thead><tr><th>department</th><th>name</th><th>salary</th><th>dept_total</th><th>rn_in_dept</th></tr></thead>
        <tbody>
          <tr><td>IT</td><td>Carol</td><td>1400</td><td>2700</td><td>1</td></tr>
          <tr><td>IT</td><td>Dave</td><td>1300</td><td>2700</td><td>2</td></tr>
          <tr><td>Sales</td><td>Alice</td><td>1200</td><td>2100</td><td>1</td></tr>
          <tr><td>Sales</td><td>Bob</td><td>900</td><td>2100</td><td>2</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <hr>

  <h2>FILTER –∏ –æ–∫–æ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏</h2>
  <p>
    –í PostgreSQL <code>FILTER</code> –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫ <strong>–∞–≥—Ä–µ–≥–∞—Ç–Ω—ã–º —Ñ—É–Ω–∫—Ü–∏—è–º</strong> –∏ –ø–æ–∑–≤–æ–ª—è–µ—Ç —É—á–∏—Ç—ã–≤–∞—Ç—å
    –≤ –∞–≥—Ä–µ–≥–∞—Ç–µ —Ç–æ–ª—å–∫–æ —Å—Ç—Ä–æ–∫–∏, —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä—è—é—â–∏–µ —É—Å–ª–æ–≤–∏—é.
    –ò —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –∏ –¥–ª—è –æ–∫–æ–Ω–Ω—ã—Ö –∞–≥—Ä–µ–≥–∞—Ç–æ–≤:
  </p>

  <pre class="sql"><code>SUM(total) FILTER (WHERE status = 'done')
OVER (PARTITION BY user_id)</code></pre>

  <div class="callout callout--note">
    <div class="callout__title">–í–∞–∂–Ω–æ</div>
    <p class="muted">
      <code>FILTER</code> –Ω–µ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫ <code>ROW_NUMBER</code>, <code>RANK</code>, <code>LAG</code>/<code>LEAD</code> ‚Äî
      –ø–æ—Ç–æ–º—É —á—Ç–æ –æ–Ω–∏ –Ω–µ –∞–≥—Ä–µ–≥–∏—Ä—É—é—Ç —Å—Ç—Ä–æ–∫–∏.
      –ù–æ –æ–Ω –æ—Ç–ª–∏—á–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å <code>SUM/COUNT/AVG/MIN/MAX</code> + <code>OVER</code>.
    </p>
  </div>

  <hr>

  <h3>–ü—Ä–∏–º–µ—Ä 10 ‚Äî SUM(...) FILTER (...) OVER (...) (—Å—É–º–º–∞ ‚Äúdone‚Äù –∏ —Å—É–º–º–∞ ‚Äú–≤—Å–µ–≥–æ‚Äù –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ)</h3>

  <p class="muted">–î–∞–Ω–Ω—ã–µ:</p>
  <div class="result">
    <div class="result__title">orders</div>
    <div class="table-wrap">
      <table>
        <thead><tr><th>id</th><th>user_id</th><th>status</th><th>total</th></tr></thead>
        <tbody>
          <tr><td>1</td><td>1</td><td>done</td><td>100</td></tr>
          <tr><td>2</td><td>1</td><td>new</td><td>50</td></tr>
          <tr><td>3</td><td>1</td><td>done</td><td>70</td></tr>
          <tr><td>4</td><td>2</td><td>new</td><td>40</td></tr>
          <tr><td>5</td><td>2</td><td>done</td><td>60</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <p class="muted">–ó–∞–ø—Ä–æ—Å:</p>
  <pre class="sql"><code>SELECT
  id,
  user_id,
  status,
  total,
  SUM(total) OVER (PARTITION BY user_id) AS total_sum,
  SUM(total) FILTER (WHERE status = 'done')
    OVER (PARTITION BY user_id) AS done_sum
FROM orders
ORDER BY user_id, id;</code></pre>

  <div class="result">
    <div class="result__title">–†–µ–∑—É–ª—å—Ç–∞—Ç:</div>
    <div class="table-wrap">
      <table>
        <thead>
          <tr><th>id</th><th>user_id</th><th>status</th><th>total</th><th>total_sum</th><th>done_sum</th></tr>
        </thead>
        <tbody>
          <tr><td>1</td><td>1</td><td>done</td><td>100</td><td>220</td><td>170</td></tr>
          <tr><td>2</td><td>1</td><td>new</td><td>50</td><td>220</td><td>170</td></tr>
          <tr><td>3</td><td>1</td><td>done</td><td>70</td><td>220</td><td>170</td></tr>
          <tr><td>4</td><td>2</td><td>new</td><td>40</td><td>100</td><td>60</td></tr>
          <tr><td>5</td><td>2</td><td>done</td><td>60</td><td>100</td><td>60</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="callout callout--tip">
    <div class="callout__title">üí° –ü–æ—á–µ–º—É —ç—Ç–æ –∫—Ä—É—Ç–æ</div>
    <p class="muted">
      –ë–µ–∑ <code>FILTER</code> –ø—Ä–∏—à–ª–æ—Å—å –±—ã –ø–∏—Å–∞—Ç—å <code>SUM(CASE WHEN ... THEN ... END) OVER (...)</code>.
      –° <code>FILTER</code> –∑–∞–ø—Ä–æ—Å –∫–æ—Ä–æ—á–µ –∏ —á–∏—Ç–∞–µ–º–µ–µ.
    </p>
  </div>

  <hr>

  <h3>–ü—Ä–∏–º–µ—Ä 11 ‚Äî COUNT(*) FILTER (...) OVER (...) (—Å—á—ë—Ç—á–∏–∫–∏ —Ä–∞–∑–Ω—ã—Ö —Å—Ç–∞—Ç—É—Å–æ–≤)</h3>

  <p class="muted">–î–∞–Ω–Ω—ã–µ:</p>
  <div class="result">
    <div class="result__title">orders</div>
    <div class="table-wrap">
      <table>
        <thead><tr><th>id</th><th>user_id</th><th>status</th></tr></thead>
        <tbody>
          <tr><td>1</td><td>1</td><td>done</td></tr>
          <tr><td>2</td><td>1</td><td>new</td></tr>
          <tr><td>3</td><td>1</td><td>done</td></tr>
          <tr><td>4</td><td>2</td><td>new</td></tr>
          <tr><td>5</td><td>2</td><td>done</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <p class="muted">–ó–∞–ø—Ä–æ—Å:</p>
  <pre class="sql"><code>SELECT
  id,
  user_id,
  status,
  COUNT(*) OVER (PARTITION BY user_id) AS orders_total,
  COUNT(*) FILTER (WHERE status = 'done') OVER (PARTITION BY user_id) AS orders_done,
  COUNT(*) FILTER (WHERE status = 'new')  OVER (PARTITION BY user_id) AS orders_new
FROM orders
ORDER BY user_id, id;</code></pre>

  <div class="result">
    <div class="result__title">–†–µ–∑—É–ª—å—Ç–∞—Ç:</div>
    <div class="table-wrap">
      <table>
        <thead>
          <tr><th>id</th><th>user_id</th><th>status</th><th>orders_total</th><th>orders_done</th><th>orders_new</th></tr>
        </thead>
        <tbody>
          <tr><td>1</td><td>1</td><td>done</td><td>3</td><td>2</td><td>1</td></tr>
          <tr><td>2</td><td>1</td><td>new</td><td>3</td><td>2</td><td>1</td></tr>
          <tr><td>3</td><td>1</td><td>done</td><td>3</td><td>2</td><td>1</td></tr>
          <tr><td>4</td><td>2</td><td>new</td><td>2</td><td>1</td><td>1</td></tr>
          <tr><td>5</td><td>2</td><td>done</td><td>2</td><td>1</td><td>1</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <hr>

  <h3>–ü—Ä–∏–º–µ—Ä 12 ‚Äî FILTER + running total (–Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω–∞—è —Å—É–º–º–∞ —Ç–æ–ª—å–∫–æ ‚Äúdone‚Äù)</h3>

  <p class="muted">–î–∞–Ω–Ω—ã–µ:</p>
  <div class="result">
    <div class="result__title">orders</div>
    <div class="table-wrap">
      <table>
        <thead><tr><th>id</th><th>user_id</th><th>status</th><th>total</th></tr></thead>
        <tbody>
          <tr><td>1</td><td>1</td><td>done</td><td>100</td></tr>
          <tr><td>2</td><td>1</td><td>new</td><td>50</td></tr>
          <tr><td>3</td><td>1</td><td>done</td><td>70</td></tr>
          <tr><td>4</td><td>1</td><td>done</td><td>30</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <p class="muted">–ó–∞–ø—Ä–æ—Å:</p>
  <pre class="sql"><code>SELECT
  id,
  status,
  total,
  SUM(total) FILTER (WHERE status = 'done')
    OVER (
      PARTITION BY user_id
      ORDER BY id
      ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW
    ) AS running_done_sum
FROM orders
ORDER BY id;</code></pre>

  <div class="result">
    <div class="result__title">–†–µ–∑—É–ª—å—Ç–∞—Ç:</div>
    <div class="table-wrap">
      <table>
        <thead><tr><th>id</th><th>status</th><th>total</th><th>running_done_sum</th></tr></thead>
        <tbody>
          <tr><td>1</td><td>done</td><td>100</td><td>100</td></tr>
          <tr><td>2</td><td>new</td><td>50</td><td>100</td></tr>
          <tr><td>3</td><td>done</td><td>70</td><td>170</td></tr>
          <tr><td>4</td><td>done</td><td>30</td><td>200</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="callout callout--note">
    <div class="callout__title">–ü–æ—á–µ–º—É —Å—Ç—Ä–æ–∫–∞ new —Ç–æ–∂–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç running_done_sum?</div>
    <p class="muted">
      –ü–æ—Ç–æ–º—É —á—Ç–æ <code>FILTER</code> –≤–ª–∏—è–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–∞ –∞–≥—Ä–µ–≥–∞—Ç, –∞ —Å—Ç—Ä–æ–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –Ω–µ —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç.
      –ü–æ—ç—Ç–æ–º—É ‚Äúnew‚Äù —Å—Ç—Ä–æ–∫–∞ —Ç–æ–∂–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—É—é —Å—É–º–º—É done –Ω–∞ —Ç–µ–∫—É—â–∏–π –º–æ–º–µ–Ω—Ç.
    </p>
  </div>

  <hr>

  <h3>–ü—Ä–∏–º–µ—Ä 13 ‚Äî FILTER vs PARTITION BY (—á–∞—Å—Ç–∞—è –ø—É—Ç–∞–Ω–∏—Ü–∞)</h3>
  <p>
    –≠—Ç–∏ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –≤—ã–≥–ª—è–¥—è—Ç –ø–æ—Ö–æ–∂–µ, –Ω–æ –¥–µ–ª–∞—é—Ç —Ä–∞–∑–Ω–æ–µ:
  </p>

  <pre class="sql"><code>-- 1) FILTER: –æ–∫–Ω–æ –ø–æ user_id, –Ω–æ –∞–≥—Ä–µ–≥–∞—Ç —Å—á–∏—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ done
SUM(total) FILTER (WHERE status = 'done')
OVER (PARTITION BY user_id)

-- 2) PARTITION BY user_id, status: —Å–æ–∑–¥–∞—ë–º –æ—Ç–¥–µ–ª—å–Ω—ã–µ –æ–∫–Ω–∞ –¥–ª—è done –∏ new
SUM(total)
OVER (PARTITION BY user_id, status)</code></pre>

  <p class="muted">–ü–æ–∫–∞–∂–µ–º —Ä–∞–∑–Ω–∏—Ü—É –Ω–∞ –ø—Ä–∏–º–µ—Ä–µ.</p>

  <p class="muted">–î–∞–Ω–Ω—ã–µ:</p>
  <div class="result">
    <div class="result__title">orders</div>
    <div class="table-wrap">
      <table>
        <thead><tr><th>id</th><th>user_id</th><th>status</th><th>total</th></tr></thead>
        <tbody>
          <tr><td>1</td><td>1</td><td>done</td><td>100</td></tr>
          <tr><td>2</td><td>1</td><td>new</td><td>50</td></tr>
          <tr><td>3</td><td>1</td><td>done</td><td>70</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <p class="muted">–ó–∞–ø—Ä–æ—Å (–æ–±–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞ —Ä—è–¥–æ–º):</p>
  <pre class="sql"><code>SELECT
  id,
  status,
  total,
  SUM(total) FILTER (WHERE status = 'done') OVER (PARTITION BY user_id) AS done_sum_filter,
  SUM(total) OVER (PARTITION BY user_id, status) AS sum_by_status_partition
FROM orders
ORDER BY id;</code></pre>

  <div class="result">
    <div class="result__title">–†–µ–∑—É–ª—å—Ç–∞—Ç:</div>
    <div class="table-wrap">
      <table>
        <thead>
          <tr><th>id</th><th>status</th><th>total</th><th>done_sum_filter</th><th>sum_by_status_partition</th></tr>
        </thead>
        <tbody>
          <tr><td>1</td><td>done</td><td>100</td><td>170</td><td>170</td></tr>
          <tr><td>2</td><td>new</td><td>50</td><td>170</td><td>50</td></tr>
          <tr><td>3</td><td>done</td><td>70</td><td>170</td><td>170</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="callout callout--warning">
    <div class="callout__title">–í—ã–≤–æ–¥</div>
    <p class="muted">
      <strong>FILTER</strong> ‚Äî ‚Äú—Ñ–∏–ª—å—Ç—Ä—É–µ–º —Å—Ç—Ä–æ–∫–∏ –≤–Ω—É—Ç—Ä–∏ –∞–≥—Ä–µ–≥–∞—Ç–∞‚Äù.<br>
      <strong>PARTITION BY ... , status</strong> ‚Äî ‚Äú—Å–æ–∑–¥–∞—ë–º —Ä–∞–∑–Ω—ã–µ –æ–∫–Ω–∞ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Å—Ç–∞—Ç—É—Å–æ–≤‚Äù.
    </p>
  </div>

  <hr>

  <h2>–ß–∞—Å—Ç—ã–µ –æ—à–∏–±–∫–∏ –∏ –Ω—é–∞–Ω—Å—ã</h2>
  <div class="callout callout--warning">
    <div class="callout__title">‚ö† –û—à–∏–±–∫–∏ –Ω–æ–≤–∏—á–∫–æ–≤</div>
    <ul class="mistakes">
      <li>
        –ü—ã—Ç–∞—Ç—å—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å <code>FILTER</code> —Å <code>ROW_NUMBER()</code>/<code>LAG()</code> ‚Äî –Ω–µ–ª—å–∑—è (–æ–Ω–∏ –Ω–µ –∞–≥—Ä–µ–≥–∞—Ç—ã).
      </li>
      <li>
        –§–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –ø–æ –æ–∫–æ–Ω–Ω–æ–π –∫–æ–ª–æ–Ω–∫–µ –ø—Ä—è–º–æ –≤ <code>WHERE</code> ‚Äî –Ω—É–∂–µ–Ω –ø–æ–¥–∑–∞–ø—Ä–æ—Å/CTE.
      </li>
      <li>
        –ó–∞–±—ã–≤–∞—Ç—å —Å—Ç–∞–±–∏–ª—å–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ –≤ —Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏–∏ (–¥–æ–±–∞–≤–ª—è–π <code>id</code> –∫–∞–∫ tie-breaker).
      </li>
      <li>
        –ù–µ –ø–æ–Ω–∏–º–∞—Ç—å —Ä–∞–∑–Ω–∏—Ü—É –º–µ–∂–¥—É <code>ROWS</code> –∏ <code>RANGE</code> ‚Äî –¥–ª—è —É—á–µ–±–Ω—ã—Ö –ø—Ä–∏–º–µ—Ä–æ–≤ —á–∞—â–µ —è–≤–Ω–æ –∑–∞–¥–∞—ë–º <code>ROWS</code>.
      </li>
    </ul>
  </div>

  <div class="callout callout--tip">
    <div class="callout__title">üí° –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–π —à–∞–±–ª–æ–Ω</div>
    <p class="muted">
      ‚Äú–°–Ω–∞—á–∞–ª–∞ –ø–æ—Å—á–∏—Ç–∞–π –æ–∫–Ω–æ, –ø–æ—Ç–æ–º —Ñ–∏–ª—å—Ç—Ä—É–π‚Äù:
    </p>
    <pre class="sql"><code>SELECT *
FROM (
  SELECT ..., ROW_NUMBER() OVER (...) AS rn
  FROM ...
) t
WHERE rn &lt;= 3;</code></pre>
  </div>

  <hr>

  <h2>–ò—Ç–æ–≥–æ</h2>
  <ul>
    <li>–û–∫–Ω–∞ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç —Å—Ç—Ä–æ–∫–∏ –∏ –¥–æ–±–∞–≤–ª—è—é—Ç –≤—ã—á–∏—Å–ª–µ–Ω–∏—è ‚Äú–ø–æ –≥—Ä—É–ø–ø–µ/–ø–æ—Ä—è–¥–∫—É‚Äù.</li>
    <li><code>PARTITION BY</code> ‚Äî –≥—Ä—É–ø–ø—ã, <code>ORDER BY</code> ‚Äî –ø–æ—Ä—è–¥–æ–∫, —Ä–∞–º–∫–∞ ‚Äî –∫–∞–∫–∏–µ —Å—Ç—Ä–æ–∫–∏ —É—á–∞—Å—Ç–≤—É—é—Ç.</li>
    <li>–ö–ª—é—á–µ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏: <code>SUM/AVG OVER</code>, <code>ROW_NUMBER/RANK</code>, <code>LAG/LEAD</code>, running totals, moving averages.</li>
    <li><code>FILTER</code> —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –∞–≥—Ä–µ–≥–∞—Ç–∞–º–∏, –≤ —Ç–æ–º —á–∏—Å–ª–µ –æ–∫–æ–Ω–Ω—ã–º–∏, –∏ –ø–æ–º–æ–≥–∞–µ—Ç —Å—á–∏—Ç–∞—Ç—å ‚Äú—É—Å–ª–æ–≤–Ω—ã–µ —Å—É–º–º—ã/—Å—á—ë—Ç—á–∏–∫–∏‚Äù –±–µ–∑ <code>CASE WHEN</code>.</li>
  </ul>
</div>
{% endblock %}
